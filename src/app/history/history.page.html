<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>Histórico</ion-title>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="home"></ion-back-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding history-page">

  <ion-card class="header-card">
    <ion-card-content>
      <ion-searchbar [(ngModel)]="searchTerm" placeholder="Buscar por espécie, tratamento..."
        debounce="300"></ion-searchbar>

      <div *ngIf="filteredHistorico.length === 0" class="ion-text-center ion-padding empty-state">
        <ion-text color="medium">
          <p>Nenhuma análise encontrada.</p>
        </ion-text>
      </div>

      <div class="table-container" *ngIf="filteredHistorico.length > 0">
        <div class="table-header">
          <div class="table-row">
            <div class="col-image">Arquivo</div>
            <div class="col-metadata">Detalhes</div>
            <div class="col-date">Data</div>
            <div class="col-area">Área Padrão</div>
            <div class="col-actions"></div>
          </div>
        </div>

        <div class="table-body">
          <div class="table-row data-row" *ngFor="let analise of filteredHistorico; trackBy: trackByHistorico"
            (click)="expandirAnalise(analise)">

            <div class="col-image">
              <div class="img-file-group">
                <div class="thumb-small">
                  <img [src]="getThumbnail(analise) || 'assets/placeholder-image.png'" alt="img" />
                </div>
                <div class="file-info">
                  <div class="file-name" [title]="analise.nomeImagem">{{ analise.nomeImagem || 'Sem nome' }}</div>
                  <div class="file-id">#{{ analise.id }}</div>
                </div>
              </div>
            </div>

            <div class="col-metadata">
              <div class="metadata-badges">
                <span class="badge" *ngIf="analise.especie">{{ analise.especie }}</span>
                <span class="badge" *ngIf="analise.tratamento">{{ analise.tratamento }}</span>
                <span class="badge empty" *ngIf="!analise.especie && !analise.tratamento">Sem dados</span>
              </div>
            </div>

            <div class="col-date">
              {{ analise.data | date:'dd/MM/yy' }}
            </div>

            <div class="col-area">
              <div class="area-highlight">
                {{ analise.areaEscala | number:'1.5-5' }} <span class="unit">cm²</span>
              </div>
            </div>

            <div class="col-actions">
              <button class="action-btn export-btn" (click)="$event.stopPropagation(); exportarAnalise(analise)">
                <ion-icon name="download-outline"></ion-icon>
              </button>
              <button class="action-btn delete-btn" (click)="$event.stopPropagation(); onDeleteAnalise(analise)">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>

          </div>
        </div>
      </div>

      <div class="ion-margin-top" *ngIf="historico.length > 0">
        <ion-button expand="block" fill="outline" color="medium" size="small" (click)="limparHistorico()">
          <ion-icon slot="start" name="trash-bin-outline"></ion-icon>
          Limpar Todo Histórico
        </ion-button>
      </div>

    </ion-card-content>
  </ion-card>

  <ion-modal [isOpen]="analiseDetalhada !== null" (didDismiss)="onModalDidDismiss($event)">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-buttons slot="start">
            <ion-button (click)="fecharDetalhes()">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>Análise Detalhada</ion-title>
          <ion-buttons slot="end">
            <ion-button *ngIf="!editingDetalhe && selectedSegment === 'resumo'" (click)="toggleEditDetalhe()">
              <ion-icon slot="icon-only" name="create-outline"></ion-icon>
            </ion-button>
            <ion-button *ngIf="editingDetalhe && selectedSegment === 'resumo'" (click)="saveEditDetalhe()"
              color="secondary" strong>
              Salvar
            </ion-button>
          </ion-buttons>
        </ion-toolbar>

        <ion-toolbar color="light">
          <ion-segment [(ngModel)]="selectedSegment" value="resumo">
            <ion-segment-button value="resumo">
              <ion-icon name="image-outline"></ion-icon>
              <ion-label>Resumo</ion-label>
            </ion-segment-button>
            <ion-segment-button value="folhas">
              <ion-icon name="list-outline"></ion-icon>
              <ion-label>Folhas ({{ analiseDetalhada?.resultados?.length || 0 }})</ion-label>
            </ion-segment-button>
          </ion-segment>
        </ion-toolbar>
      </ion-header>

      <ion-content class="modal-body" *ngIf="analiseDetalhada">

        <div *ngIf="selectedSegment === 'resumo'" class="fade-in">

          <div class="ion-padding">

            <!-- Informações da Análise -->
            <div class="analysis-info-section ion-margin-bottom">
              <div class="analysis-info-card">
                <div class="analysis-image-section">
                  <div class="analysis-thumbnail">
                    <img [src]="getThumbnail(analiseDetalhada)" *ngIf="getThumbnail(analiseDetalhada)"
                      (click)="abrirImagemAmpliada()" style="cursor: pointer;" />
                    <ion-icon name="image-outline" *ngIf="!getThumbnail(analiseDetalhada)" size="large"></ion-icon>
                  </div>
                </div>
                <div class="analysis-details-section">
                  <div *ngIf="!editingDetalhe">
                    <h3 class="analysis-title">{{ analiseDetalhada.nomeImagem || 'Sem nome' }}</h3>
                    <div class="analysis-detail-item">
                      <span class="detail-label">Espécie:</span>
                      <span class="detail-value">{{ analiseDetalhada.especie || '—' }}</span>
                    </div>
                    <div class="analysis-detail-item">
                      <span class="detail-label">Tratamento:</span>
                      <span class="detail-value">{{ analiseDetalhada.tratamento || '—' }}</span>
                    </div>
                    <div class="analysis-detail-item">
                      <span class="detail-label">Réplica:</span>
                      <span class="detail-value">{{ analiseDetalhada.replica || '—' }}</span>
                    </div>
                    <div class="analysis-detail-item">
                      <span class="detail-label">Área Padrão:</span>
                      <span class="detail-value">{{ analiseDetalhada.areaEscala | number:'1.5-5' }} cm²</span>
                    </div>
                  </div>

                  <!-- Formulário de Edição -->
                  <div *ngIf="editingDetalhe" class="edit-form">
                    <h3 class="edit-title">Editar Informações da Amostra</h3>
                    <ion-item lines="none" class="edit-item">
                      <ion-label position="stacked">Espécie</ion-label>
                      <ion-input [(ngModel)]="editModel.especie" placeholder="Digite a espécie"></ion-input>
                    </ion-item>
                    <ion-item lines="none" class="edit-item">
                      <ion-label position="stacked">Tratamento</ion-label>
                      <ion-input [(ngModel)]="editModel.tratamento" placeholder="Digite o tratamento"></ion-input>
                    </ion-item>
                    <ion-item lines="none" class="edit-item">
                      <ion-label position="stacked">Réplica</ion-label>
                      <ion-input [(ngModel)]="editModel.replica" placeholder="Digite a réplica"></ion-input>
                    </ion-item>
                    <div class="edit-actions">
                      <ion-button fill="solid" color="medium" (click)="cancelEditDetalhe()">
                        <ion-icon slot="start" name="close-outline"></ion-icon>
                        Cancelar
                      </ion-button>
                      <ion-button fill="solid" color="primary" (click)="saveEditDetalhe()">
                        <ion-icon slot="start" name="checkmark-outline"></ion-icon>
                        Salvar
                      </ion-button>
                    </div>
                  </div>
                </div>
              </div>
            </div>



            <div *ngIf="analiseDetalhada.resultadosAgregados as agg" class="ion-margin-top">
              <h3 class="section-title">Resumo Estatístico</h3>

              <div class="stats-dashboard">
                <div class="stat-card primary">
                  <div class="stat-icon"><ion-icon name="analytics-outline"></ion-icon></div>
                  <div class="stat-content">
                    <span class="stat-label">Soma das Áreas</span>
                    <span class="stat-value">{{ (agg.somaAreas || agg.totalArea || 0) | number:'1.5-5' }}
                      <small>cm²</small></span>
                  </div>
                </div>

                <h4 class="section-subtitle">Largura:</h4>

                <div class="stat-grid">
                  <div class="mini-stat">
                    <span class="label">Largura Média</span>
                    <span class="value">{{ (agg.mediaLargura || agg.averageWidth || 0) | number:'1.5-5' }}</span>
                  </div>
                  <div class="mini-stat">
                    <span class="label">Desvio Padrão</span>
                    <span class="value">{{ (agg.desvioLargura || agg.standardDeviationWidth || 0) | number:'1.5-5' }}</span>
                  </div>
                </div>

                <h4 class="section-subtitle">Comprimento:</h4>

                <div class="stat-grid">
                  <div class="mini-stat">
                    <span class="label">Comprimento Médio</span>
                    <span class="value">{{ (agg.mediaComprimento || agg.averageLength || 0) | number:'1.5-5' }}</span>
                  </div>
                  <div class="mini-stat">
                    <span class="label">Desvio Padrão</span>
                    <span class="value">{{ (agg.desvioComprimento || agg.standardDeviationLength || 0) | number:'1.5-5' }}</span>
                  </div>
                </div>

                <h4 class="section-subtitle">Área:</h4>

                <div class="stat-grid">
                  <div class="mini-stat">
                    <span class="label">Área Média</span>
                    <span class="value">{{ (agg.mediaArea || agg.averageArea || 0) | number:'1.5-5' }}</span>
                  </div>
                  <div class="mini-stat">
                    <span class="label">Desvio Padrão</span>
                    <span class="value">{{ (agg.desvioArea || agg.standardDeviationArea || 0) | number:'1.5-5' }}</span>
                  </div>
                </div>

                <h4 class="section-subtitle">Perímetro:</h4>

                <div class="stat-grid">
                  <div class="mini-stat">
                    <span class="label">Perímetro Médio</span>
                    <span class="value">{{ (agg.mediaPerimetro || agg.averagePerimeter || 0) | number:'1.5-5' }}</span>
                  </div>
                  <div class="mini-stat">
                    <span class="label">Desvio Padrão</span>
                    <span class="value">{{ (agg.desvioPerimetro || agg.standardDeviationPerimeter || 0) | number:'1.5-5' }}</span>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <div *ngIf="selectedSegment === 'folhas'" class="fade-in">
          <ion-list lines="none" *ngIf="analiseDetalhada.resultados?.length; else emptyResults">

            <ion-accordion-group>
              <ion-accordion *ngFor="let r of analiseDetalhada.resultados" [value]="'leaf_'+r.id">

                <ion-item slot="header" color="light">
                  <ion-badge slot="start" color="medium">{{ r.id }}</ion-badge>
                  <ion-label>
                    <h2>Folha {{ r.id }}</h2>
                    <p>Área: {{ r.area | number:'1.5-5' }} cm²</p>
                  </ion-label>
                </ion-item>

                <div class="ion-padding" slot="content">
                  <ion-grid class="leaf-details-grid">
                    <ion-row>
                      <ion-col size="12">
                        <div class="detail-box">
                          <span class="lbl">Largura</span>
                          <span class="val">{{ r.largura | number:'1.5-5' }} cm</span>
                        </div>
                      </ion-col>
                      <ion-col size="12">
                        <div class="detail-box">
                          <span class="lbl">Comprimento</span>
                          <span class="val">{{ r.comprimento | number:'1.5-5' }} cm</span>
                        </div>
                      </ion-col>
                      <ion-col size="12">
                        <div class="detail-box">
                          <span class="lbl">Relação L/C</span>
                          <span class="val">{{ r.relacaoLarguraComprimento | number:'1.5-5' }}</span>
                        </div>
                      </ion-col>
                      <ion-col size="12">
                        <div class="detail-box">
                          <span class="lbl">Área</span>
                          <span class="val">{{ r.area | number:'1.5-5' }} cm²</span>
                        </div>
                      </ion-col>
                      <ion-col size="12">
                        <div class="detail-box">
                          <span class="lbl">Perímetro</span>
                          <span class="val">{{ r.perimetro | number:'1.5-5' }} cm</span>
                        </div>
                      </ion-col>
                    </ion-row>
                  </ion-grid>
                </div>

              </ion-accordion>
            </ion-accordion-group>
          </ion-list>

          <ng-template #emptyResults>
            <div class="ion-padding ion-text-center">
              <ion-text color="medium">Não há medições individuais gravadas.</ion-text>
            </div>
          </ng-template>
        </div>

        <div style="height: 60px"></div>
      </ion-content>

      <ion-footer>
        <ion-toolbar>
          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-button expand="block" fill="outline" color="danger" (click)="onDeleteAnalise(analiseDetalhada)">
                  <ion-icon slot="start" name="trash-outline"></ion-icon>
                  Excluir
                </ion-button>
              </ion-col>
              <ion-col>
                <ion-button expand="block" color="primary" (click)="exportarAnalise(analiseDetalhada)">
                  <ion-icon slot="start" name="download-outline"></ion-icon>
                  Exportar CSV
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-toolbar>
      </ion-footer>
    </ng-template>
  </ion-modal>

  <!-- Modal para imagem ampliada -->
  <ion-modal [isOpen]="imagemAmpliada !== null" (didDismiss)="fecharImagemAmpliada()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-buttons slot="start">
            <ion-button (click)="fecharImagemAmpliada()">
              <ion-icon slot="icon-only" name="close"></ion-icon>
            </ion-button>
          </ion-buttons>
          <ion-title>Imagem Ampliada</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding" style="text-align: center;">
        <img [src]="imagemAmpliada" style="max-width: 100%; max-height: 100%; object-fit: contain;" />
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>