<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-title>L.I.M.A.</ion-title>
    <ion-buttons slot="end" class="header-buttons">

      <ion-button fill="clear" *ngIf="getCurrentUser()">
        <ion-icon name="person"></ion-icon>
      </ion-button>

      <ion-button (click)="toggleTheme()" fill="clear">
        <ion-icon slot="icon-only" [name]="darkMode ? 'sunny' : 'moon'"></ion-icon>
      </ion-button>

      <ion-button (click)="confirmarLogout()" fill="clear">
        <ion-icon slot="icon-only" name="log-out"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>

  <div *ngIf="isAnalyzing" class="loading-overlay">
    <div class="loading-content">
      <ion-spinner name="crescent" color="success"></ion-spinner>
      <p>carregando análise</p>
    </div>
  </div>

  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">L.I.M.A.</ion-title>
    </ion-toolbar>
  </ion-header>

  <div class="ion-padding main-container">
    <ion-grid>
      <ion-row >

        <ion-col size="12" size-md="7" class="config-column">

          <ion-card class="config-card">
            <ion-card-header class="ion-no-padding">
              <ion-card-title>Configuração</ion-card-title>
            </ion-card-header>

            <ion-card-content>

              <ion-grid class="leaf-grid">
                <ion-row>
                  <ion-col size="12" size-md="4">
                    <ion-item class="compact-item">
                      <ion-label position="stacked">Espécie:</ion-label>
                      <ion-input [(ngModel)]="especie" placeholder="Digite a espécie"></ion-input>
                    </ion-item>
                  </ion-col>

                  <ion-col size="12" size-md="4">
                    <ion-item class="compact-item">
                      <ion-label position="stacked">Tratamento:</ion-label>
                      <ion-input [(ngModel)]="tratamento" placeholder="Digite o tratamento"></ion-input>
                    </ion-item>
                  </ion-col>

                  <ion-col size="12" size-md="4">
                    <ion-item class="compact-item">
                      <ion-label position="stacked">Réplica:</ion-label>
                      <ion-input [(ngModel)]="replica" placeholder="Digite a réplica"></ion-input>
                    </ion-item>
                  </ion-col>
                </ion-row>
              </ion-grid>

              <ion-item class="compact-item">
                <ion-label position="stacked">Área do Padrão de Escala (cm²):</ion-label>
                <ion-input [(ngModel)]="areaEscala" type="number" placeholder="Digite a área do padrão" required></ion-input>
              </ion-item>

              <ion-label class="section-label">Medidas a Calcular:</ion-label>

              <div class="medidas-container">
                <!-- agora usa medidasOptions definido no TS -->
                <ion-item class="checkbox-item" *ngFor="let m of medidasOptions">
                  <ion-checkbox slot="start" [(ngModel)]="medidasSelecionadas[m.key]"></ion-checkbox>
                  <ion-label>{{ m.label }}</ion-label>
                </ion-item>
              </div>

              <ion-grid class="ion-no-padding">
                <ion-row>

                  <ion-col>
                    <ion-button expand="block" (click)="selecionarImagem()">
                      <ion-icon slot="start" name="image"></ion-icon>
                      Selecionar
                    </ion-button>
                  </ion-col>

                  <ion-col>
                    <ion-button expand="block" color="success" (click)="calcular()" [disabled]="isAnalyzing">
                      <ion-spinner *ngIf="isAnalyzing"></ion-spinner>
                      <ion-icon *ngIf="!isAnalyzing" slot="start" name="calculator"></ion-icon>
                      <span *ngIf="isAnalyzing" class="ml-2">Analisando...</span>
                      <span *ngIf="!isAnalyzing">Analisar</span>
                    </ion-button>
                  </ion-col>

                  <ion-col>
                    <ion-button expand="block" color="light" (click)="resetAnalise()">
                      <ion-icon slot="start" name="trash"></ion-icon>
                      Limpar
                    </ion-button>
                  </ion-col>

                </ion-row>
              </ion-grid>

            </ion-card-content>
          </ion-card>

          <!-- RESULTADOS -->
          <ion-card class="results-card">
            <ion-card-header class="results-header-container">
              <div class="results-header">
                <ion-card-title>Resultados</ion-card-title>

              <ion-buttons>
              <ion-button fill="clear" (click)="navegarParaHistorico()">
                <ion-icon name="time"></ion-icon>
                Histórico
              </ion-button>

              <ion-button fill="clear" (click)="navegarParaAjuda()">
                <ion-icon name="help"></ion-icon>
                Ajuda
              </ion-button>

              <ion-button
                fill="clear"
                color="danger"
                (click)="presentDeleteSelectionAlert()"
                *ngIf="resultados.length > 0"
              >
              <ion-icon name="trash"></ion-icon>
                Excluir
              </ion-button>
            </ion-buttons>
            </div>
          </ion-card-header>


            <ion-card-content>

              <!-- Lista individual -->
              <div *ngFor="let r of resultados">
                <ion-item button detail="false" lines="none" (click)="toggleLeafDetails(r.id)" class="leaf-item-card">
                  <ion-label>Folha {{ r.id }}</ion-label>
                  <ion-icon slot="end" [name]="visibleLeafDetails.has(r.id) ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
                </ion-item>

                <ion-list class="leaf-details-list" *ngIf="visibleLeafDetails.has(r.id)">

                  <ion-item *ngIf="medidasSelecionadas.largura">
                    <ion-label>Largura:</ion-label>
                    <ion-note slot="end">{{ r.largura | number:'1.5-5' }} cm</ion-note>
                  </ion-item>

                  <ion-item *ngIf="medidasSelecionadas.comprimento">
                    <ion-label>Comprimento:</ion-label>
                    <ion-note slot="end">{{ r.comprimento | number:'1.5-5' }} cm</ion-note>
                  </ion-item>

                  <ion-item *ngIf="medidasSelecionadas.relacaoLarguraComprimento">
                    <ion-label>Relação L/C:</ion-label>
                    <ion-note slot="end">{{ r.relacaoLarguraComprimento | number:'1.5-5' }}</ion-note>
                  </ion-item>

                  <ion-item *ngIf="medidasSelecionadas.area">
                    <ion-label>Área:</ion-label>
                    <ion-note slot="end">{{ r.area | number:'1.5-5' }} cm²</ion-note>
                  </ion-item>

                  <ion-item *ngIf="medidasSelecionadas.perimetro">
                    <ion-label>Perímetro:</ion-label>
                    <ion-note slot="end">{{ r.perimetro | number:'1.5-5' }} cm</ion-note>
                  </ion-item>

                </ion-list>
              </div>

              <!-- Agregados -->
              <div *ngIf="medidasSelecionadas.somarAreas || medidasSelecionadas.mediaDesvio">
                <ion-item class="leaf-item-card" button detail="false" lines="none" (click)="toggleAggregatedResults()">
                  <ion-label>De todas as folhas</ion-label>
                  <ion-icon slot="end" [name]="aggregatedResultsVisible ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
                </ion-item>

                <ion-list class="leaf-details-list" *ngIf="aggregatedResultsVisible">

                  <ion-item *ngIf="medidasSelecionadas.somarAreas">
                    <ion-label>Soma Total das Áreas:</ion-label>
                    <ion-note slot="end">{{ resultadosAgregados?.totalArea | number:'1.2-2' }} cm²</ion-note>
                  </ion-item>

                  <ng-container *ngIf="medidasSelecionadas.mediaDesvio">
                    <ion-item>
                      <ion-label>Média da Largura:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.averageWidth | number:'1.5-5' }} cm</ion-note>
                    </ion-item>

                    <ion-item>
                      <ion-label>Média do Comprimento:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.averageLength | number:'1.5-5' }} cm</ion-note>
                    </ion-item>

                    <ion-item>
                      <ion-label>Média da Área:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.averageArea | number:'1.5-5' }} cm²</ion-note>
                    </ion-item>

                    <ion-item>
                      <ion-label>Média do Perímetro:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.averagePerimeter | number:'1.5-5' }} cm</ion-note>
                    </ion-item>

                    <ion-item>
                      <ion-label>Desvio da Largura:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.standardDeviationWidth | number:'1.5-5' }} cm</ion-note>
                    </ion-item>

                    <ion-item>
                      <ion-label>Desvio do Comprimento:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.standardDeviationLength | number:'1.5-5' }} cm</ion-note>
                    </ion-item>

                    <ion-item *ngIf="medidasSelecionadas.relacaoLarguraComprimento">
                      <ion-label>Média da Relação L/C:</ion-label>
                      <ion-note slot="end">{{ resultadosAgregados?.averageWidthToLengthRatio | number:'1.5-5' }}</ion-note>
                    </ion-item>
                  </ng-container>

                </ion-list>

              </div>

              <!-- Sem dados -->
              <div *ngIf="resultados.length === 0" class="ion-text-center ion-padding">
                <ion-text color="medium">Nenhum resultado disponível</ion-text>
              </div>

              <ion-button expand="block" color="tertiary" class="export-button" [disabled]="resultados.length === 0" (click)="exportarResultados()">
                <ion-icon slot="start" name="download"></ion-icon>
                Exportar Resultados
              </ion-button>

            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="5" class="image-column">
          <ion-card class="image-card">
            <ion-card-header>
              <ion-card-title>{{ imagemProcessada ? 'Imagem Processada' : 'Imagem' }}</ion-card-title>
            </ion-card-header>

            <ion-card-content>
              <div class="image-container">
                <ion-img *ngIf="hasImage" [src]="imagemProcessada || imagemSelecionada"></ion-img>
                <ion-text *ngIf="!hasImage" color="medium" class="placeholder-text">
                  Selecione uma imagem para análise
                </ion-text>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

</ion-content>
